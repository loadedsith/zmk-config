on: [push, pull_request, workflow_dispatch]

jobs:
  # Keep your standard ZMK build via the reusable workflow
  zmk:
    uses: zmkfirmware/zmk/.github/workflows/build-user-config.yml@main
    with:
      build_matrix_path: build.yaml

  dts_right:
    name: Dump DTS (right half)
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: read
      actions: write

    steps:
      - uses: actions/checkout@v4

      # Build inside the container, but only for this step
      - name: Build right (produce zephyr.dts)
        uses: docker://zmkfirmware/zmk-build-arm:stable
        with:
          entrypoint: /bin/bash
          args: >-
            -lc "set -euxo pipefail &&
            ls -la &&
            test -f config/west.yml &&
            west init -l config &&
            # trust the mounted workspace for Git inside the container
            git config --global --add safe.directory /github/workspace &&
            git config --global --add safe.directory /github/workspace/zephyr ||
            true &&
            # or, to trust everything in CI (simplest):
            git config --global --add safe.directory '*' &&
            git config --global --get-all safe.directory &&
            west update &&
            west build -s zmk/app -b nice_nano_v2 -- -DSHIELD='waterfowl_right nice_oled' -DDTC_OVERLAY_FILE='config/waterfowl_right.overlay'"
      - name: List artifacts (sanity)
        run: ls -la build/zephyr || true

      - name: Upload DTS
        uses: actions/upload-artifact@v4
        with:
          name: dts-waterfowl-right
          if-no-files-found: error
          path: |
            build/zephyr/zephyr.dts
            build/zephyr/zephyr.dtsi
