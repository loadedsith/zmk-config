on: [push, pull_request, workflow_dispatch]

jobs:
  # Keep your standard ZMK build via the reusable workflow
  zmk:
    uses: zmkfirmware/zmk/.github/workflows/build-user-config.yml@main
    with:
      build_matrix_path: build.yaml

  # One-off right-half build to grab zephyr.dts
  dts_right:
    name: Dump DTS (right half)
    needs: zmk
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: read        # lets the runner pull ghcr.io images
      actions: write   # <-- needed for artifact uploads on some setups
    container:
      image: ghcr.io/zmkfirmware/zmk-build-arm:stable
    steps:
      - name: Checkout config
        uses: actions/checkout@v4

      - name: Build right (produce zephyr.dts)
        run: |
          west init -l .
          west update
          west build -s zmk/app -b nice_nano_v2 \
            -- -DSHIELD="waterfowl_right nice_oled" \
               -DDTC_OVERLAY_FILE="config/waterfowl_right.overlay"

      - name: Upload DTS
        if: ${{ always() }}
        uses: actions/upload-artifact@v3
        with:
          name: dts-waterfowl-right
          if-no-files-found: error
          path: |
            build/zephyr/zephyr.dts
            build/zephyr/zephyr.dtsi
